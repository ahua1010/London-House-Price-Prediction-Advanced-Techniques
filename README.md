# 倫敦房價預測：趨勢分離與高級集成學習模型

## 專案概覽

本專案旨在對倫敦地區的房價進行精準預測。其核心方法論基於一個創新的「混合模型」架構，該架構將房價波動分解為兩個主要部分：
1.  **長期趨勢 (Trend)**：由總體經濟、時間流逝和季節性因素驅動的市場基礎價格變化。
2.  **短期殘差 (Residuals)**：由房產自身的具體特徵（如地理位置、面積、房型等）導致的價格偏離。

通過將這兩個問題分開處理，並結合複雜的特徵工程與多層次的集成學習，本模型能夠在Kaggle競賽等場景下取得具有競爭力的成果。

---

## 核心架構與概念

### 1. 混合模型 (Hybrid Model)

這是整個專案的基石。`HybridModel` 類別實現了以下流程：
- **第一步：趨勢建模**
  - 使用一個簡單、穩健的線性模型（如 `Ridge` 回歸）來學習由 `time_numeric` 和其他確定性時間序列特徵（如傅立葉項）所代表的長期價格趨勢。
- **第二步：殘差計算**
  - 從真實價格中減去趨勢模型的預測值，得到「去趨勢化」的殘差。這些殘差代表了由房產個體屬性決定的價值。
- **第三步：殘差學習**
  - 使用一個強大的、非線性的梯度提升模型（如 `LGBMRegressor` 或 `XGBRegressor`）來學習房產特徵與這些殘差之間的複雜關係。
- **最終預測**：
  - `最終預測價 = 趨勢模型預測的趨勢價 + 機器學習模型預測的殘差價`

### 2. Stacking 集成學習

為了進一步提升模型的穩定性和準確性，專案採用了 Stacking（堆疊）集成策略。但這裡的 "Stacking" 實現為一種更穩健的**多模型平均集成**：
- **基礎模型 (Base Models)**：我們定義了多個結構相同但核心算法不同的基礎模型（例如，一個使用 LGBM 的混合模型，另一個使用 XGBoost 的混合模型）。
- **K-Fold 交叉驗證訓練**：整個訓練集被分成 K 個摺疊（Folds）。模型在 K-1 個摺疊上訓練，並在剩下的一個摺疊上進行預測。這個過程重複 K 次，直到每個摺疊都被預測過一次。
- **最終集成預測**：在預測新數據時，我們會調用所有在 K-Fold 訓練過程中產生的模型（總共 `K * N` 個，其中 N 是基礎模型的數量），讓它們分別進行預測，然後將所有預測結果取**算術平均值**。這極大地降低了模型過擬合的風險。

---

## 特徵工程管線

數據預處理和特徵工程是本專案成功的關鍵。主要步驟如下：

1.  **時間特徵 (`create_time_features`, `create_time_series_features`)**
    - 將年份和月份轉換為標準的時間格式。
    - 創建數值化的時間戳 `time_numeric` 作為趨勢模型的核心輸入。
    - 使用 `DeterministicProcess` 生成傅立葉項，以捕捉季節性與週期性波動。

2.  **地址與地理特徵 (`preprocess_address_features`, `engineer_address_features`, `engineer_geo_features`)**
    - 從詳細地址 `fullAddress` 中提取街道類型 (`street_type`)、是否為公寓 (`is_flat_or_apt`) 等結構化資訊。
    - 計算房產到倫敦市中心、金融城等地標的 `haversine` 直線距離。
    - 使用 `KMeans` 對經緯度進行聚類，生成地理分區特徵。
    - 創建經緯度的交互特徵（如乘積、比例）。

3.  **自動化特徵組合 (`better_features`)**
    - 一個自動化腳本，遍歷所有數值特徵，進行加、減、乘、除四則運算，生成候選的新特徵。
    - 通過計算新特徵與目標（房價）的相關性，以及與現有特徵的冗餘性，來自動篩選出最有效的新組合特徵。

4.  **缺失值處理 (`handle_missing_values`)**
    - 採用多種策略，包括使用最頻繁值填充，以及訓練簡單的回歸模型來預測並填充關鍵特徵（如用面積預測臥室和浴室數量）。

5.  **自定義編碼器 (`CustomEncoder`)**
    - 一個智能編碼器，對不同類型的類別特徵採取不同策略：
        - **目標編碼 (Target Encoding)**：對高基數的類別特徵（如郵遞區號 `outcode`），使用其對應的平均房價進行編碼。
        - **順序編碼 (Ordinal Encoding)**：對具有內在順序的特徵（如能源評級 `currentEnergyRating`）進行編碼。
        - **分箱編碼 (Binning)**：對經緯度等連續特徵進行分箱，以捕捉非線性關係。

---

## 如何執行

### 環境需求
- **平台**：此 Notebook 設計為在 **Kaggle** 環境中運行。
- **硬體**：需要啟用 **GPU** 加速器，因為 `LGBMRegressor` 和 `XGBRegressor` 都被配置為使用 GPU。
- **依賴庫**：
  ```
  pandas, numpy, scikit-learn, lightgbm, xgboost, statsmodels, optuna, tqdm
  ```

### 數據結構
- 腳本預期輸入數據位於 `/kaggle/input/new-london-house-price/` 目錄下。
- 包含 `train.csv`, `test.csv`, 和 `sample_submission.csv` 三個檔案。

### 執行流程
1.  將 `trend-ml-plus.ipynb` 上傳到 Kaggle Notebook 環境。
2.  掛載 `new-london-house-price` 數據集。
3.  按順序執行 Notebook 中的所有儲存格。
4.  `main()` 函數將會被調用，它會自動化地完成從數據加載、特徵工程、模型訓練到最終預測的全部流程。

---

## 產出
- 腳本執行完成後，會在輸出目錄（通常是 `/kaggle/working/`）生成一個名為 `submission_RandomKFold.csv` 的檔案。
- 此檔案符合 Kaggle 競賽的提交格式，可以直接用於提交。 